<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Total Volume Tanks</title>
    <script src="https://cdn.jsdelivr.net/npm/@metamask/web3-provider@^0.2.0/dist/web3-provider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@^1.2.2/dist/web3.min.js"></script>
  </head>
  <body>
    <h1>Total Volume Tanks</h1>
    <p id="status">Please connect your Metamask wallet to continue.</p>
    <button id="connect">Connect</button>
    <br><br>
    <table id="data">
      <tr>
        <td>Current Block Time:</td>
        <td id="currentBlockTime"></td>
      </tr>
      <tr>
        <td>Current Tank Walls:</td>
        <td id="currentTankWalls"></td>
      </tr>
      <tr>
        <td>Total Tanks:</td>
        <td id="totalTanks"></td>
      </tr>
      <tr>
        <td>Current Water Volume:</td>
        <td id="currentWaterVolume"></td>
      </tr>
      <tr>
        <td>Total Water Volume:</td>
        <td id="totalWaterVolume"></td>
      </tr>
    </table>
    <br><br>
    <table id="grid">
    </table>
    <br><br>
    <button id="createNewMap">Create New Map</button>
    <button id="currentTankTotalWaterVolume">Calculate Total Volume</button>

    <script>
      const connectButton = document.getElementById("connect");
      const statusDisplay = document.getElementById("status");
      const currentBlockTimeDisplay = document.getElementById("currentBlockTime");
      const currentTankWallsDisplay = document.getElementById("currentTankWalls");
      const totalTanksDisplay = document.getElementById("totalTanks");
      const currentWaterVolumeDisplay = document.getElementById("currentWaterVolume");
      const totalWaterVolumeDisplay = document.getElementById("totalWaterVolume");
      const gridDisplay = document.getElementById("grid");
      const createNewMapButton = document.getElementById("createNewMap");
      const currentTankTotalWaterVolumeButton = document.getElementById("currentTankTotalWaterVolume");

      let web3;
      let totalVolumeTanks;

      async function connect() {
        web3 = new Web3(new Web3.providers.Web3Provider(window.ethereum));
        const accounts = await web3.eth.getAccounts();
        const networkId = await web3.eth.net.getId();

        totalVolumeTanks = new web3
.eth.Contract(
TotalVolumeTanksABI,
TotalVolumeTanksAddress,
{ from: accounts[0] }
);

statusDisplay.innerHTML = `Connected to Metamask as ${accounts[0]}`;

    updateData();
    setInterval(updateData, 2000);
  }

  async function updateData() {
    currentBlockTimeDisplay.innerHTML = await totalVolumeTanks.methods.currentBlockTime().call();
    currentTankWallsDisplay.innerHTML = await totalVolumeTanks.methods.currentTankWalls().call();
    totalTanksDisplay.innerHTML = await totalVolumeTanks.methods.totalTanks().call();
    currentWaterVolumeDisplay.innerHTML = await totalVolumeTanks.methods.currentWaterVolume().call();
    totalWaterVolumeDisplay.innerHTML = await totalVolumeTanks.methods.totalWaterVolume().call();

    gridDisplay.innerHTML = "";
    for (let i = 0; i < currentTankWallsDisplay.innerHTML.length; i++) {
      gridDisplay.innerHTML += `<tr><td>${currentTankWallsDisplay.innerHTML[i].length}</td><td>${currentTankWallsDisplay.innerHTML[i].height}</td></tr>`;
    }
  }

  createNewMapButton.addEventListener("click", async function() {
    await totalVolumeTanks.methods.createNewMap().send({ from: accounts[0] });
    updateData();
  });

  currentTankTotalWaterVolumeButton.addEventListener("click", async function() {
    const totalVolume = await totalVolumeTanks.methods.calculateTotalVolume().send({ from: accounts[0] });
    alert(`The total volume is: ${totalVolume}`);
  });

  connectButton.addEventListener("click", function() {
    window.ethereum.enable().then(connect);
  });
</script>
  </body>
</html>
